---
name: Security Audit (pip-audit)

on:
  pull_request:
  workflow_dispatch:
  schedule:
    # Run weekly on Tuesdays at 03:23 UTC
    - cron: "23 3 * * 2"

concurrency:
  group: pip-audit-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  DEFAULT_PYTHON: "3.13"
  UV_SYSTEM_PYTHON: 1

jobs:
  audit-pr:
    name: Audit Dependencies (PR)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "0.7.9"
          enable-cache: true

      - name: Set up Python ${{ env.DEFAULT_PYTHON }}
        uses: actions/setup-python@v5.6.0
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}

      - name: Install pip-audit
        run: uv pip install pip-audit

      - name: Export requirements
        run: |
          # Combine all requirements for comprehensive audit
          cat requirements.txt requirements_test.txt > all_requirements.txt

      - name: Run pip-audit (report only)
        id: audit
        continue-on-error: true
        run: |
          pip-audit -r all_requirements.txt --format json --output audit-results.json || true

          # Parse results
          if [ -f audit-results.json ]; then
            VULNS=$(cat audit-results.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(len([v for dep in d.get('dependencies', []) for v in dep.get('vulns', [])]))" 2>/dev/null || echo "0")
            FIXABLE=$(cat audit-results.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(len([v for dep in d.get('dependencies', []) for v in dep.get('vulns', []) if v.get('fix_versions')]))" 2>/dev/null || echo "0")
          else
            VULNS=0
            FIXABLE=0
          fi

          echo "vulns=$VULNS" >> $GITHUB_OUTPUT
          echo "fixable=$FIXABLE" >> $GITHUB_OUTPUT

      - name: Generate summary
        run: |
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.audit.outputs.vulns }}" = "0" ]; then
            echo "No known vulnerabilities found in dependencies." >> $GITHUB_STEP_SUMMARY
          else
            echo "Found **${{ steps.audit.outputs.vulns }}** vulnerabilities (${{ steps.audit.outputs.fixable }} fixable)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Details" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            pip-audit -r all_requirements.txt 2>/dev/null || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Warn on vulnerabilities
        if: steps.audit.outputs.vulns != '0'
        run: |
          echo "::warning::Found ${{ steps.audit.outputs.vulns }} vulnerabilities in dependencies"

  autofix:
    name: Auto-fix Vulnerabilities
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "0.7.9"
          enable-cache: true

      - name: Set up Python ${{ env.DEFAULT_PYTHON }}
        uses: actions/setup-python@v5.6.0
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}

      - name: Install pip-audit
        run: uv pip install pip-audit

      - name: Run pip-audit and check for fixable issues
        id: audit
        run: |
          cat requirements.txt requirements_test.txt > all_requirements.txt

          # Run audit and capture output
          pip-audit -r all_requirements.txt --format json --output audit-results.json || true

          if [ -f audit-results.json ]; then
            FIXABLE=$(cat audit-results.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(len([v for dep in d.get('dependencies', []) for v in dep.get('vulns', []) if v.get('fix_versions')]))" 2>/dev/null || echo "0")
          else
            FIXABLE=0
          fi

          echo "fixable=$FIXABLE" >> $GITHUB_OUTPUT
          echo "Found $FIXABLE fixable vulnerabilities"

      - name: Update requirements if fixes available
        if: steps.audit.outputs.fixable != '0'
        run: |
          # Use pip-audit to suggest fixes
          echo "## Attempting to update vulnerable packages..."

          # Get list of packages with fixes
          PACKAGES_TO_UPDATE=$(cat audit-results.json | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          packages = set()
          for dep in d.get('dependencies', []):
              for vuln in dep.get('vulns', []):
                  if vuln.get('fix_versions'):
                      packages.add(dep.get('name'))
          print(' '.join(packages))
          " 2>/dev/null || echo "")

          if [ -n "$PACKAGES_TO_UPDATE" ]; then
            echo "Packages to update: $PACKAGES_TO_UPDATE"
            # Note: This is a simple approach - in a real scenario you might want
            # to use pip-compile or similar tools to properly update requirements
            for pkg in $PACKAGES_TO_UPDATE; do
              # Update version in requirements files if present
              pip-audit -r all_requirements.txt --fix --dry-run 2>/dev/null || true
            done
          fi

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet requirements*.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "security: update dependencies with security fixes"
          title: "Security: Apply pip-audit fixes"
          body: |
            ## Automated Security Update

            This PR was automatically created by the pip-audit workflow.

            **Changes:**
            - Updated dependencies with known security vulnerabilities

            **Note:** Please review the changes carefully before merging.

            ---
            _This is an automated PR. See the [pip-audit workflow](.github/workflows/pip-audit.yml) for details._
          branch: security/pip-audit-fixes
          labels: |
            security
            dependencies
            automated-pr
